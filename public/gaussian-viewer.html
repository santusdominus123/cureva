<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gaussian Splat Viewer</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }

    #container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      z-index: 1000;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3b82f6;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #info {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 100;
      display: none;
    }

    #error {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(239, 68, 68, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
      max-width: 500px;
    }
  </style>
</head>
<body>
  <div id="container"></div>

  <div id="loading">
    <div class="spinner"></div>
    <p>Initializing Viewer...</p>
  </div>

  <div id="info">
    <strong>Controls:</strong><br>
    Left Click + Drag: Rotate<br>
    Right Click + Drag: Pan<br>
    Scroll: Zoom
  </div>

  <div id="error"></div>

  <!-- Import map for module resolution -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.module.js",
        "@mkkellogg/gaussian-splats-3d": "https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.5.1/build/gaussian-splats-3d.module.js"
      }
    }
  </script>

  <script type="module">
    import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';

    let viewer = null;
    let currentScene = null;

    const loading = document.getElementById('loading');
    const info = document.getElementById('info');
    const errorDiv = document.getElementById('error');

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showLoading(text = 'Loading...') {
      loading.querySelector('p').textContent = text;
      loading.style.display = 'block';
    }

    function hideLoading() {
      loading.style.display = 'none';
    }

    // Initialize viewer
    async function initViewer() {
      try {
        showLoading('Initializing Viewer...');

        viewer = new GaussianSplats3D.Viewer({
          rootElement: document.getElementById('container'),
          selfDrivenMode: true,
          useBuiltInControls: true,
          progressiveLoad: true,
          antialiased: true,
          gpuAcceleratedSort: typeof SharedArrayBuffer !== 'undefined' && self.crossOriginIsolated,
        });

        await viewer.init();

        hideLoading();
        info.style.display = 'block';

        // Notify parent that viewer is ready
        window.parent.postMessage({
          type: 'viewer-ready',
          ready: true
        }, '*');

        console.log('Viewer initialized successfully');
      } catch (err) {
        console.error('Failed to initialize viewer:', err);
        showError('Failed to initialize viewer: ' + err.message);
        hideLoading();
      }
    }

    // Load Gaussian Splat file
    async function loadSplatFile(fileData, fileName) {
      try {
        showLoading('Loading Gaussian Splat...');

        // Clear previous scene
        if (currentScene !== null) {
          viewer.removeSplatScene(currentScene);
          currentScene = null;
        }

        // Create blob URL from file data
        const blob = new Blob([fileData], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);

        // Detect format
        let format = GaussianSplats3D.SceneFormat.Ply;
        if (fileName.toLowerCase().endsWith('.ksplat')) {
          format = GaussianSplats3D.SceneFormat.KSplat;
        } else if (fileName.toLowerCase().endsWith('.splat')) {
          format = GaussianSplats3D.SceneFormat.Splat;
        }

        // Load scene
        currentScene = await viewer.addSplatScene(url, {
          format: format,
          progressiveLoad: true,
          onProgress: (progress) => {
            const percent = Math.min(100, Math.max(0, Math.round(progress * 100)));
            showLoading(`Loading: ${percent}%`);

            // Notify parent of progress
            window.parent.postMessage({
              type: 'load-progress',
              progress: percent
            }, '*');
          }
        });

        // Clean up blob URL
        URL.revokeObjectURL(url);

        hideLoading();

        // Notify parent that loading is complete
        window.parent.postMessage({
          type: 'load-complete',
          fileName: fileName,
          format: format
        }, '*');

        console.log('File loaded successfully');
      } catch (err) {
        console.error('Failed to load file:', err);
        showError('Failed to load file: ' + err.message);
        hideLoading();

        // Notify parent of error
        window.parent.postMessage({
          type: 'load-error',
          error: err.message
        }, '*');
      }
    }

    // Listen for messages from parent window
    window.addEventListener('message', async (event) => {
      const { type, data, fileName } = event.data;

      switch (type) {
        case 'load-file':
          if (data && fileName) {
            // Convert base64 to ArrayBuffer
            const binaryString = atob(data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            await loadSplatFile(bytes.buffer, fileName);
          }
          break;

        case 'reset-camera':
          if (viewer && viewer.controls) {
            viewer.controls.reset();
          }
          break;

        case 'take-screenshot':
          if (viewer && viewer.renderer) {
            const canvas = viewer.renderer.domElement;
            const dataUrl = canvas.toDataURL('image/png');
            window.parent.postMessage({
              type: 'screenshot-data',
              data: dataUrl
            }, '*');
          }
          break;
      }
    });

    // Initialize on load
    initViewer();
  </script>
</body>
</html>
